<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Welcome to GeeMail</title>
    <script src="js/mail-generator.js"></script>
    <script src="js/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet" media="screen">
    <link rel="icon" type="image/png" href="files/favicon.png">
    <script>
      window.onload = function() {
        var inboxCount = document.querySelector('#inbox-count');
        var mainContainer = document.querySelector('#main-container');
        var mainBody = document.createElement('div');
        mainBody.id = 'main-body';

        // load initial 10 emails and create ID system for use in deletion
        var _id = 0;
        geemails.forEach(function(geemail) {
          geemail._id = _id;
          mainBody.innerHTML +=
            '<div id="' +
            _id +
            '" class="email"><div class="email-header">' +
            '<div class="email-header-top"><div class="email-sender">' +
            geemail.sender +
            '</div><div class="email-date">' +
            geemail.date.toLocaleDateString() +
            '</div></div><div class="email-header-bottom"><div class="email-subject">' +
            geemail.subject +
            '</div><div class="trash">' +
            '<i class="feather-trash" data-feather="trash-2"></i>' +
            '</div></div></div><div class="email-body email-body-hidden">' +
            geemail.body +
            '</div></div>';
          _id++;
          mainContainer.appendChild(mainBody);
        });
        inboxCount.textContent = geemails.length;

        // create function to open/close email by clicking email header
        function addOpenClose(email) {
          email.children[0].addEventListener('mouseup', function() {
            this.classList.add('read-email');
            this.classList.toggle('open-email');
            this.parentNode.children[1].classList.toggle('email-body-hidden');
          });
        }

        // create function to remove array object that corresponds to DOM element
        function removeArrayObject(email) {
          for (var i = 0; i < geemails.length; i++) {
            if (geemails[i]._id === Number(email.id)) {
              geemails.splice(i, 1);
            }
          }
        }

        // create function to delete email by clicking trash icon
        function addDelete(email) {
          email.children[0].children[1].children[1].addEventListener(
            'mouseup',
            function(event) {
              removeArrayObject(email);
              email.classList.add('fade-email');
              setTimeout(function() {
                email.remove();
              }, 400);
              event.stopPropagation();
              inboxCount.textContent = geemails.length;
            }
          );
        }

        function createNewEmail() {
          var newMessage = getNewMessage();
          newMessage._id = _id;
          geemails.push(newMessage);
          var newEmail = document.createElement('div');
          var lastIndex = geemails.length - 1;
          newEmail.id = _id;
          newEmail.className = 'email email-incoming';
          newEmail.innerHTML =
            '<div class="email-header">' +
            '<div class="email-header-top"><div class="email-sender">' +
            geemails[lastIndex].sender +
            '</div><div class="email-date">' +
            geemails[lastIndex].date.toLocaleDateString() +
            '</div></div><div class="email-header-bottom"><div class="email-subject">' +
            geemails[lastIndex].subject +
            '</div><div class="trash">' +
            '<i class="feather-trash" data-feather="trash-2"></i>' +
            '</div></div></div><div class="email-body email-body-hidden">' +
            geemails[lastIndex].body +
            '</div>';
          return newEmail;
        }

        // add functionality to open/close/delete initial 10 emails
        var emails = document.querySelectorAll('.email');
        emails.forEach(function(email) {
          addOpenClose(email);
          addDelete(email);
        });

        // push new email (with open/close/delete options) to inbox at set interval
        window.setInterval(function() {
          var newEmail = createNewEmail();
          _id++;
          mainBody.insertBefore(newEmail, mainBody.childNodes[0]);
          setTimeout(function() {
            newEmail.classList.remove('email-incoming');
          }, 10);          
          addOpenClose(newEmail);
          addDelete(newEmail);
          inboxCount.textContent = geemails.length;
          feather.replace();
        }, 7777); // All Lucky 7s!
        feather.replace();
      };
    </script>
  </head>
  <body>
    <div id="content">
      <div id="header">
        <div id="header-container">
          <div id="logo">
            <div><i class="feather-mail" data-feather="mail"></i></div>
            <div>GeeMail</div>
          </div>
          <div id="greeting">
            <div>Welcome,</div>
            <div id="name">DevLeague!</div>
          </div>
        </div>
      </div>
      <div id="subheader">
        <div id="subheader-container">
          <div id="inbox">
            <div id="inbox-title">Inbox</div>
            <div id="inbox-total">Total (<span id="inbox-count"></span>)</div>
          </div>
        </div>
      </div>
      <div id="main">
        <div id="main-container"></div>
      </div>
    </div>
    <div id="footer">
      <div id="footer-container">
        Â© 2018 GeeMail. All Rights Reserved.
      </div>
    </div>
  </body>
</html>